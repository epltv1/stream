<!DOCTYPE html>
<html>
<head>
  <title>Stream Player</title>
  <link rel="stylesheet" href="https://vjs.zencdn.net/8.10.0/video-js.css">
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <script src="https://unpkg.com/@videojs/http-streaming@3.10.0/dist/videojs-http-streaming.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background: #000; }
    .player { position: relative; width: 100%; height: 100vh; }
    .video-js { width: 100%; height: 100%; object-fit: contain; }
    .live { position: absolute; top: 10px; left: 10px; background: #e11; color: white; padding: 4px 8px; border-radius: 4px; font: bold 12px sans-serif; z-index: 10; }
    .viewers { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font: 12px sans-serif; z-index: 10; }
    .hd-badge { position: absolute; top: 10px; left: 60px; background: #e11; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; z-index: 10; display: none; }
    .vjs-control-bar { background: rgba(0,0,0,0.6); }
    .vjs-quality-selector .vjs-menu-button::before { content: '\f013'; font-family: 'Font Awesome 6 Free'; font-weight: 900; }
    @media (max-width: 768px) { .player { height: 50vh; } }
    @media (min-width: 1200px) { .player { height: 80vh; } }
  </style>
</head>
<body>
  <div class="player">
    <video id="video" class="video-js vjs-default-skin" playsinline preload="auto"></video>
    <div class="live">LIVE</div>
    <div class="hd-badge">HD</div>
    <div class="viewers" id="viewers">0 viewers</div>
  </div>
  <script>
    const streamId = window.location.pathname.split('/').pop().replace('.php', '');
    const socket = io();
    const player = videojs('video', {
      controls: true,
      controlBar: {
        pictureInPictureToggle: true,
        fullscreenToggle: true,
        qualitySelector: true
      }
    });

    fetch(`/api/streams/${streamId}`).then(r => r.json()).then(stream => {
      document.title = stream.title + " - Live";
      player.src({ src: `/proxy/${streamId}`, type: 'application/x-mpegURL' });
      player.httpStreaming();
      player.on('resolutionchange', () => {
        const resolution = player.currentSource().resolution;
        document.querySelector('.hd-badge').style.display = resolution && parseInt(resolution) >= 720 ? 'block' : 'none';
      });
      player.on('loadedmetadata', () => {
        const sources = player.currentSources();
        if (sources.length <= 1) {
          const controlBar = document.querySelector('.vjs-quality-selector');
          if (controlBar) controlBar.style.display = 'none';
        }
      });
    }).catch(() => document.body.innerHTML = '<h1 style="color:white;text-align:center;">Stream not found or inactive</h1>');

    socket.emit('join-stream', streamId);
    socket.on('viewer-count', c => {
      document.getElementById('viewers').textContent = c + ` viewer${c !== 1 ? 's' : ''}`;
    });
  </script>
</body>
</html>

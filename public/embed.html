<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    .player { position: relative; width: 100%; height: 100vh; background: #000; }
    video { width: 100%; height: 100%; object-fit: contain; }
    .live { position: absolute; top: 10px; left: 10px; background: #e11; color: white; padding: 4px 8px; border-radius: 4px; font: bold 12px sans-serif; }
    .viewers { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font: 12px sans-serif; }
    .controls { position: absolute; bottom: 10px; right: 10px; display: flex; gap: 5px; z-index: 10; }
    button, select { background: rgba(0,0,0,0.6); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 16px; }
    select { padding: 6px; font-size: 14px; }
    .hd-badge { position: absolute; top: 10px; left: 60px; background: #e11; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; display: none; }
  </style>
</head>
<body>
  <div class="player">
    <video id="video" playsinline></video>
    <div class="live">LIVE</div>
    <div class="hd-badge">HD</div>
    <div class="viewers" id="viewers">0 viewers</div>
    <div class="controls">
      <button id="pip" title="Picture-in-Picture"><i class="fas fa-tv"></i></button>
      <select id="quality" title="Quality"></select>
      <button id="fs" title="Fullscreen"><i class="fas fa-expand"></i></button>
    </div>
  </div>
  <script>
    const streamId = window.location.pathname.split('/').pop();
    const socket = io();
    let hls;

    fetch(`/api/streams/${streamId}`).then(r => r.json()).then(stream => {
      document.title = stream.title + " - Live";
      if (Hls.isSupported()) {
        hls = new Hls({ enableWorker: true });
        hls.loadSource(`/proxy/${streamId}`);
        hls.attachMedia(document.getElementById('video'));

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          const levels = hls.levels;
          const sel = document.getElementById('quality');
          if (levels.length <= 1) {
            sel.innerHTML = '<option>Auto</option>';
            if (levels[0]?.height >= 720) document.querySelector('.hd-badge').style.display = 'block';
          } else {
            sel.innerHTML = '<option value="-1">Auto</option>';
            levels.forEach((l, i) => {
              const opt = document.createElement('option');
              opt.value = i; opt.text = l.height + 'p';
              sel.appendChild(opt);
              if (l.height >= 720 && i === hls.currentLevel) document.querySelector('.hd-badge').style.display = 'block';
            });
          }
          sel.onchange = () => {
            hls.currentLevel = sel.value === '-1' ? -1 : +sel.value;
            document.querySelector('.hd-badge').style.display = sel.value >= 0 && levels[sel.value].height >= 720 ? 'block' : 'none';
          };
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = `/proxy/${streamId}`;
        document.querySelector('.hd-badge').style.display = 'block'; // Assume native is HD
      }
    }).catch(() => document.body.innerHTML = '<h1>Stream not found or inactive</h1>');

    document.getElementById('pip').onclick = () => {
      const v = document.getElementById('video');
      document.pictureInPictureElement ? document.exitPictureInPicture() : v.requestPictureInPicture();
    };

    document.getElementById('fs').onclick = () => {
      document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen();
    };

    socket.emit('join-stream', streamId);
    socket.on('viewer-count', c => {
      document.getElementById('viewers').textContent = c + ` viewer${c !== 1 ? 's' : ''}`;
    });
  </script>
</body>
</html>
